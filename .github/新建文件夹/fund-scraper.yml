name: è´¹ç‡

on:
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'fetch_fund_fee.py'
      - '.github/workflows/fund-scraper.yml'
      - 'Cç±».txt'
  schedule:
    # æ¯å¤©ä¸Šæµ·æ—¶é—´ 09:30ï¼ˆUTC 01:30ï¼‰
    - cron: '30 1 * * *'

jobs:
  fetch:
    runs-on: ubuntu-latest
    permissions:
      # æˆäºˆå·¥ä½œæµå¯¹å†…å®¹ä»“åº“çš„å†™å…¥æƒé™ï¼Œä»¥è¿›è¡Œæäº¤å’Œæ¨é€
      contents: write

    steps:
      - name: Checkout Repository ğŸ›’
        uses: actions/checkout@v4

      - name: Set up Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies ğŸ› ï¸
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pandas

      - name: Run Python script to fetch data ğŸš€
        env:
          # è®¾ç½®æ—¶åŒºï¼Œç¡®ä¿è„šæœ¬å†…éƒ¨çš„æ—¶é—´æˆ³æ˜¯ä¸Šæµ·æ—¶é—´
          TZ: Asia/Shanghai
        run: |
          python fetch_fund_fee.py
          
      # --- å…³é”®çš„æäº¤å’Œæ¨é€æ­¥éª¤ ---
      - name: Commit and Push CSV if changed âœ¨
        run: |
          # 1. é…ç½® Git èº«ä»½
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 2. å°†ç»“æœæ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº (æ³¨æ„ï¼šä½¿ç”¨ fund_data/ ç›®å½•è·¯å¾„)
          git add fund_data/fund_fee_result.csv
          
          # 3. æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰æ–°çš„å˜æ›´
          # git diff --cached --exit-code è¿”å› 0 è¡¨ç¤ºæ²¡æœ‰å˜åŒ–
          if git diff --cached --exit-code; then
            echo "âœ… fund_data/fund_fee_result.csv å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤å’Œæ¨é€ã€‚"
          else
            # 4. å¦‚æœæœ‰å˜åŒ–ï¼Œåˆ™åˆ›å»ºæäº¤
            COMMIT_MESSAGE="Update fund_fee_result.csv $(TZ=Asia/Shanghai date '+%F %T')"
            git commit -m "$COMMIT_MESSAGE"
            
            # --- ä¿®å¤æ¨é€å†²çªï¼šå…ˆæ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´å¹¶Rebase ---
            echo "ğŸ”„ å°è¯•æ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´å¹¶ Rebase åˆå¹¶..."
            git pull --rebase
            
            # 5. æ¨é€æäº¤åˆ°è¿œç¨‹ä»“åº“
            echo "ğŸš€ æ­£åœ¨æ¨é€æ–°çš„ fund_data/fund_fee_result.csv..."
            git push
          fi
