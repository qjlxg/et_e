name: ğŸ’° Fund Analysis & Push

# è§¦å‘å™¨é…ç½®
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'analyze_funds.py'
      - '.github/workflows/analysis.yml'
      - 'fund_data/*.csv'

env:
  TZ: Asia/Shanghai
  OUTPUT_FILE: fund_analysis_summary.csv # å®šä¹‰è¾“å‡ºæ–‡ä»¶åï¼Œä¾¿äºGitæ­¥éª¤ä½¿ç”¨

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    steps:
    
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 
          
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      - name: âš™ï¸ Install Dependencies (Pandas, NumPy)
        run: pip install pandas numpy
          
      # æ­¥éª¤ 4: æ‰§è¡Œåˆ†æè„šæœ¬
      - name: ğŸ“ˆ Run Fund Analysis Script
        run: python analyze_funds.py
        
      # æ­¥éª¤ 5: æäº¤å¹¶æ¨é€ç»“æœåˆ°ä»“åº“ (ä¿®å¤å¼ºåˆ¶æ¨é€é€»è¾‘)
      - name: â¬†ï¸ Commit and Push Results (${{ env.OUTPUT_FILE }})
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f ${{ env.OUTPUT_FILE }} ]; then
            # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°çš„æˆ–ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
            git add ${{ env.OUTPUT_FILE }}
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å¾…æäº¤çš„æ›´æ”¹
            if git status --porcelain | grep -q ${{ env.OUTPUT_FILE }}; then
              git commit -m "Auto: Update fund analysis summary with new metrics (Shanghai Time) [skip ci]"
              # æ¨é€åˆ°ä»“åº“
              git push
              echo "Successfully pushed updated analysis summary."
            else
              echo "${{ env.OUTPUT_FILE }} æ–‡ä»¶å†…å®¹æœªå‘ç”Ÿå®è´¨æ€§å˜åŒ–ã€‚è·³è¿‡æäº¤ã€‚"
            fi
          else
            echo "é”™è¯¯ï¼šè„šæœ¬æœªèƒ½ç”Ÿæˆ ${{ env.OUTPUT_FILE }}ã€‚"
            exit 1
          fi
