name: å›æµ‹ä¸æŠ¥å‘Šæ¨é€ (Fund Backtest and Report Push)

# --- è§¦å‘æ¡ä»¶é…ç½® ---
on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual trigger for V5.0 backtesting'

  # 2. è‡ªåŠ¨è§¦å‘ï¼šå½“ç‰¹å®šæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      # å…¼å®¹æ‰€æœ‰ backtester è„šæœ¬
      - 'backtester*.py'
      - '.github/workflows/backtest_and_push.yml'

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai'
  # ***** å…³é”®ä¿®å¤ 1: æŠ¥å‘Šæ–‡ä»¶åæ›´æ–°ä¸º V5.0 è„šæœ¬çš„è¾“å‡º *****
  REPORT_FILE_NAME: 'fund_backtest_v5_report.md'
  REPORT_DIR: 'backtest_reports' # æŠ¥å‘Šä¿å­˜çš„ç›®å½•

jobs:
  run_backtest_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: â±ï¸ è®¾ç½®æ—¶åŒº (ä¸Šæµ·)
        run: echo "TZ=${{ env.TZ }}" >> $GITHUB_ENV

      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        # å¢åŠ  fetch-depthï¼Œç¡®ä¿èƒ½æ­£ç¡®æ‰§è¡Œ git pull/rebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¥ å®‰è£…ä¾èµ– (Install dependencies)
        # V5.0 è„šæœ¬ä¾èµ– pandas, numpy å’Œ pytz
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pytz

      - name: ğŸ“‚ æ£€æŸ¥æ•°æ®ç›®å½• (Check fund_data directory)
        run: |
          if [ ! -d "fund_data" ]; then
            echo "::error:: fund_data ç›®å½•ä¸å­˜åœ¨ï¼è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»ºè¯¥ç›®å½•å¹¶æ”¾å…¥CSVæ–‡ä»¶ã€‚"
            exit 1
          fi

      # ***** å…³é”®ä¿®å¤ 2: è¿è¡Œ V5.0 è„šæœ¬ *****
      - name: ğŸš€ è¿è¡Œ V5.0 å›æµ‹è„šæœ¬ (Run backtester_v5.py)
        run: python backtester_v5.py

      # ***** æ–°å¢æ­¥éª¤: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼Œé˜²æ­¢ mv æŠ¥é”™ *****
      - name: ğŸ” æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ (é˜²mvæŠ¥é”™)
        id: check_report
        run: |
          if [ -f "${{ env.REPORT_FILE_NAME }}" ]; then
            echo "report_found=true" >> $GITHUB_OUTPUT
            echo "âœ… æŠ¥å‘Šæ–‡ä»¶ ${{ env.REPORT_FILE_NAME }} æˆåŠŸæ‰¾åˆ°ã€‚"
          else
            echo "report_found=false" >> $GITHUB_OUTPUT
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶ ${{ env.REPORT_FILE_NAME }} æœªç”Ÿæˆï¼Œè„šæœ¬å¯èƒ½å› æ•°æ®ä¸è¶³è€Œè·³è¿‡æˆ–æŠ¥é”™ã€‚"
          fi

      # åªæœ‰å½“æŠ¥å‘Šæ–‡ä»¶æ‰¾åˆ°æ—¶ï¼Œæ‰æ‰§è¡Œåç»­çš„ Git æ“ä½œ (ä½¿ç”¨ if æ¡ä»¶)
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“ ç§»åŠ¨å’Œæš‚å­˜æŠ¥å‘Šæ–‡ä»¶
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          mkdir -p ${{ env.REPORT_DIR }}

          # ç”Ÿæˆå¸¦æ—¶åŒºçš„ç²¾ç¡®æ—¶é—´æˆ³ (å·²ä¿®å¤ï¼šä½¿ç”¨å•å¼•å·åŒ…è£¹æ ¼å¼å­—ç¬¦ä¸²)
          TIMESTAMP=$(TZ='${{ env.TZ }}' date '+%Y%m%d_%H%M%S')
          TARGET_FILE="${{ env.REPORT_DIR }}/backtest_report_${TIMESTAMP}.md"

          # ç§»åŠ¨æŠ¥å‘Šæ–‡ä»¶
          mv ${{ env.REPORT_FILE_NAME }} ${TARGET_FILE}

          git add ${TARGET_FILE}

          # æ­¤å¤–ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º "latest.md" çš„æ–‡ä»¶ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹æœ€æ–°ç»“æœ
          cp ${TARGET_FILE} ${{ env.REPORT_DIR }}/latest.md
          git add ${{ env.REPORT_DIR }}/latest.md

      - name: â¬†ï¸ æ¨é€æŠ¥å‘Šåˆ°ä»“åº“ (Push report to repository)
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          if git diff --cached --exit-code; then
            echo "æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆï¼Œæ— éœ€æäº¤ã€‚"
          else
            # æäº¤ä¿¡æ¯ä¹Ÿæ”¹ä¸º V5 (å·²ä¿®å¤ï¼šä½¿ç”¨å•å¼•å·åŒ…è£¹æ ¼å¼å­—ç¬¦ä¸²)
            COMMIT_MSG="ğŸ¤– Auto-generated V5 backtest report: $(TZ='${{ env.TZ }}' date '+%Y-%m-%d %H:%M:%S')"
            git commit -m "${COMMIT_MSG}"

            # â­ï¸ å…³é”®ä¿®å¤ï¼šåœ¨æ¨é€å‰å…ˆæ‹‰å–å¹¶åˆå¹¶è¿œç¨‹æ›´æ”¹
            # ä½¿ç”¨ --rebase é¿å…ç”Ÿæˆé¢å¤–çš„åˆå¹¶æäº¤ï¼Œè§£å†³ 'fetch first' é”™è¯¯ã€‚
            echo "å°è¯•æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶åˆå¹¶..."
            git pull --rebase origin main

            # å†æ¬¡æ¨é€
            echo "å°è¯•æ¨é€è‡³è¿œç¨‹ä»“åº“..."
            git push
          fi
