name: ğŸ“Š Index Analysis Report Generation

# --- è§¦å‘æ¡ä»¶é…ç½® ---
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 2. å½“å…³é”®æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'index_analysis.py'       # é‡åŒ–åˆ†æè„šæœ¬å˜åŠ¨
      - 'fund_basic_data_c_class.csv' # ä¾èµ–çš„æ•°æ®æ–‡ä»¶å˜åŠ¨
      - '.github/workflows/analyze_index.yml' # å·¥ä½œæµæ–‡ä»¶æœ¬èº«å˜åŠ¨
      
  # 3. æ¯æ—¥å®šæ—¶è‡ªåŠ¨è¿è¡Œï¼ˆä¸Šæµ·æ—¶é—´æ—©ä¸Š 8:00ï¼‰
  schedule:
    # 0 0 * * * æ˜¯ UTC 0:00ï¼Œé€šè¿‡æ—¶åŒºè½¬æ¢ï¼Œç›¸å½“äºä¸Šæµ·æ—¶é—´ 8:00
    - cron: '0 0 * * *'

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    # ç¡®ä¿æœ‰å†™å…¥æƒé™æ¥æäº¤æ–‡ä»¶
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ– (ç§»é™¤äº† apt-get å‘½ä»¤)
      - name: Install dependencies (AkShare, TA-Lib)
        run: |
          python -m pip install --upgrade pip
          pip install pandas akshare
          
          # å°è¯•ç›´æ¥å®‰è£… ta-lib
          # å¦‚æœç›´æ¥å®‰è£…å¤±è´¥ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦ä½¿ç”¨ç‰¹å®šçš„é¢„ç¼–è¯‘ wheel æ–‡ä»¶
          pip install ta-lib

      # æ­¥éª¤ 4: è¿è¡ŒæŒ‡æ•°åˆ†æè„šæœ¬ (ç”Ÿæˆ index_analysis_report.txt)
      - name: Run index analysis script and save report
        run: python -u index_analysis.py > index_analysis_report.txt

      # æ­¥éª¤ 5: è®¾ç½®æ–‡ä»¶è·¯å¾„å’Œæ—¶é—´æˆ³ (ä½¿ç”¨çº¯ Bash å‘½ä»¤è®¾ç½®ä¸Šæµ·æ—¶åŒº)
      - name: Set path and timestamp variables (Shanghai Time)
        id: vars
        run: |
          # çº¯ Bash è„šæœ¬ï¼Œä½¿ç”¨ TZ ç¯å¢ƒå˜é‡è®¾ç½®æ—¶åŒºæ¥ç”Ÿæˆæ—¶é—´æˆ³
          export TZ='Asia/Shanghai'
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          YEAR_MONTH=$(date +'%Y/%m')
          
          # å®šä¹‰æœ€ç»ˆè·¯å¾„å’Œæ–‡ä»¶å
          REPORT_FILENAME="index_analysis_report_${TIMESTAMP}.txt"
          REPORT_NEW_PATH="${YEAR_MONTH}/${REPORT_FILENAME}"
          
          echo "REPORT_NEW_PATH=${REPORT_NEW_PATH}" >> $GITHUB_OUTPUT
          echo "YEAR_MONTH=${YEAR_MONTH}" >> $GITHUB_OUTPUT
          echo "COMMIT_MESSAGE=Automated analysis report: ${YEAR_MONTH} index signals" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 6: ç§»åŠ¨æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•å¹¶é‡å‘½å
      - name: Move and rename report to target path
        run: |
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p ${{ steps.vars.outputs.YEAR_MONTH }}
          
          # ç§»åŠ¨å’Œé‡å‘½å åˆ†ææŠ¥å‘Šæ–‡ä»¶
          mv index_analysis_report.txt ${{ steps.vars.outputs.REPORT_NEW_PATH }}

      # æ­¥éª¤ 7: é…ç½® Git æäº¤ä¿¡æ¯
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 8: æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: Commit and push new report
        run: |
          git add ${{ steps.vars.outputs.YEAR_MONTH }}
          git commit -m "${{ steps.vars.outputs.COMMIT_MESSAGE }}"
          git push

      # æ­¥éª¤ 9: æ‰“å°æ¨é€ç»“æœ
      - name: Success message
        run: echo "ğŸ‰ é‡åŒ–åˆ†ææŠ¥å‘Šå·²æˆåŠŸæ¨é€åˆ°ä»“åº“çš„ /${{ steps.vars.outputs.YEAR_MONTH }}/ ç›®å½•ä¸‹ã€‚"
