name: Run Market Monitor_c

on:
  schedule:
    # æ¯å¤©æ™šä¸ŠåŒ—äº¬æ—¶é—´21ç‚¹å¼€å§‹æ¯åŠå°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œè¿ç»­è¿è¡Œ2æ¬¡ã€‚
    # åŒ—äº¬æ—¶é—´21:00å’Œ21:30å¯¹åº”UTCæ—¶é—´13:00å’Œ13:30
    - cron: '0,30 13 * * *'
  push:
    paths:
      - 'analysis_report.md'
      - 'result_Cç±».txt'
      - 'market_monitor_c.py'
      - '.github/workflows/market_monitor_c.yml'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    timeout-minutes: 60 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache fund data
        uses: actions/cache@v4
        with:
          path: fund_data
          key: ${{ runner.os }}-fund-data
          restore-keys: |
            ${{ runner.os }}-fund-data

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pandas numpy requests tenacity lxml tabulate
        
      - name: Run Market Monitor script and Move Report
        id: run_script
        run: |
          # ğŸ’¡ æ”¹è¿›ï¼šè®¾ç½®æ—¶åŒºï¼Œç¡®ä¿æ–‡ä»¶åæ—¶é—´æˆ³æ˜¯åŒ—äº¬æ—¶é—´
          export TZ='Asia/Shanghai'
          
          # æ¸…é™¤è„šæœ¬å®é™…ç”Ÿæˆçš„æ–°æ—¥å¿—æ–‡ä»¶
          rm -f market_monitor_c.log
          
          # è¿è¡Œè„šæœ¬ï¼Œå¹¶æ£€æŸ¥æ–°çš„æ—¥å¿—æ–‡ä»¶
          python market_monitor_c.py || { echo "Script failed, check market_monitor_c.log"; cat market_monitor_c.log 2>/dev/null || echo "No log file generated"; exit 1; }
          
          # æ ¼å¼åŒ–æ—¥æœŸå’Œæ—¶é—´
          REPORT_YEAR=$(date +'%Y')
          REPORT_MONTH=$(date +'%m')
          REPORT_DATE=$(date +'%Y-%m-%d')
          TIMESTAMP=$(date +'%H%M%S')
          
          # æ„é€ ç›®æ ‡ç›®å½• (e.g., 2025/10)
          TARGET_DIR="${REPORT_YEAR}/${REPORT_MONTH}"
          
          # æ„é€ æ–°çš„æŠ¥å‘Šæ–‡ä»¶å (e.g., 2025-10-09_210000_c.md)
          NEW_REPORT_NAME="${REPORT_DATE}_${TIMESTAMP}_c.md"
          TARGET_PATH="${TARGET_DIR}/${NEW_REPORT_NAME}"

          # æ£€æŸ¥å¹¶åˆ›å»ºç›®æ ‡ç›®å½• (å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º)
          echo "Creating target directory: ${TARGET_DIR}"
          mkdir -p "${TARGET_DIR}"
          
          # æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶ç§»åŠ¨åˆ°ç›®æ ‡è·¯å¾„
          if [ -f market_monitor_report_c.md ]; then
            echo "Moving market_monitor_report_c.md to ${TARGET_PATH}"
            mv market_monitor_report_c.md "${TARGET_PATH}"
            # âš ï¸ ä¿®æ­£ï¼šä½¿ç”¨ $GITHUB_OUTPUT è®¾ç½®è¾“å‡º
            echo "new_report_path=${TARGET_PATH}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check generated files
        run: |
          echo "Checking generated files:"
          
          # è¯»å–è¾“å‡ºçš„æ–¹å¼ä¿æŒä¸å˜
          NEW_REPORT_PATH=${{ steps.run_script.outputs.new_report_path }}
          
          # æ£€æŸ¥å¹¶æ‰“å°æ–°çš„æŠ¥å‘Šæ–‡ä»¶å†…å®¹
          if [ -f "${NEW_REPORT_PATH}" ]; then
            echo "Contents of ${NEW_REPORT_PATH}:"
            cat "${NEW_REPORT_PATH}"
            # æ£€æŸ¥æ–°çš„æ–‡ä»¶å
            ls -l "${NEW_REPORT_PATH}" 2>/dev/null
          fi
          
          # æ£€æŸ¥å¹¶æ‰“å°æ–°çš„æ—¥å¿—æ–‡ä»¶å†…å®¹ (æ—¥å¿—æ–‡ä»¶ä»ä¿ç•™åœ¨æ ¹ç›®å½•)
          if [ -f market_monitor_c.log ]; then
            echo "Contents of market_monitor_c.log:"
            cat market_monitor_c.log
          fi
          
          if [ -d fund_data ]; then
            echo "Fund data directory contents (still in root):"
            ls -l fund_data
          fi

      - name: Commit and push results
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          # è·å–æ–°æŠ¥å‘Šæ–‡ä»¶è·¯å¾„
          NEW_REPORT_PATH=${{ steps.run_script.outputs.new_report_path }}
          
          # æäº¤æ–°çš„æŠ¥å‘Šæ–‡ä»¶è·¯å¾„ (åŒ…æ‹¬ç›®å½•)
          if [ -n "${NEW_REPORT_PATH}" ]; then
            git add "${NEW_REPORT_PATH}"
            REPORT_FILENAME=$(basename "${NEW_REPORT_PATH}")
          fi
          
          # æäº¤æ—¥å¿—æ–‡ä»¶å’Œ fund_data (ä¿ç•™åœ¨æ ¹ç›®å½•)
          git add market_monitor_c.log
          git add fund_data
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # æäº¤ä¿¡æ¯ä¸­åŒ…å«æŠ¥å‘Šæ–‡ä»¶å
            COMMIT_MESSAGE="Update market monitor report (${REPORT_FILENAME}) and fund data - $(date)"
            git commit -m "${COMMIT_MESSAGE}"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
