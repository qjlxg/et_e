name: æ•°æ®æ›´æ–°

on:
  
  schedule:
    - cron: '0 13 * * *' 
  
  # é€šè¿‡æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘ï¼Œä¸”ä»…å½“æŒ‡å®šçš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶
  push:
    branches:
      - main
    paths:
      - '.github/workflows/æ•°æ®æ›´æ–°-fund_spider.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'

jobs:
  run_spider:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu æ“ä½œç³»ç»Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  (Checkout repository)
      uses: actions/checkout@v4
      with:
        # ç¡®ä¿è·å–å®Œæ•´çš„ Git å†å²è®°å½•
        fetch-depth: 0 

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: è®¾ç½®æ—¶åŒº 
      run: |
        sudo apt-get update
        sudo apt-get install -y tzdata 
        sudo timedatectl set-timezone 'Asia/Shanghai'
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        # å®‰è£… fund_spider.py æ‰€éœ€çš„æ‰€æœ‰åº“
        pip install pandas requests aiohttp beautifulsoup4 tenacity json5 jsbeautifier lxml
        
    - name: è¿è¡ŒåŸºé‡‘çˆ¬è™«è„šæœ¬
      run: |
        echo "å¼€å§‹æ‰§è¡Œ fund_spider.py..."
        # è¿è¡Œçˆ¬è™«è„šæœ¬ï¼ŒæŠ“å–å¹¶æ›´æ–°æ•°æ®
        python fund_spider.py
        
    - name: â­ è§£å†³æ¨é€å†²çªï¼šæš‚å­˜ã€æ‹‰å–ã€æ¢å¤ (Git Stash/Pull ä¿®å¤)
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ›´æ”¹ï¼ˆçˆ¬è™«è„šæœ¬çš„è¾“å‡ºï¼‰
        if ! git diff-index --quiet HEAD --; then
          echo "å‘ç°æœ¬åœ°æ›´æ”¹ï¼Œæ­£åœ¨æš‚å­˜..."
          git stash
          STASHED=true
        else
          echo "æ— æœ¬åœ°æ›´æ”¹ï¼Œè·³è¿‡æš‚å­˜ã€‚"
          STASHED=false
        fi
        
        # 2. æ‹‰å–å¹¶åˆå¹¶è¿œç¨‹ main åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹
        echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull origin main
        
        # 3. å¦‚æœä¹‹å‰æœ‰æš‚å­˜ï¼Œåˆ™æ¢å¤æš‚å­˜çš„æ›´æ”¹
        if [ "$STASHED" = true ]; then
          echo "æ¢å¤æš‚å­˜çš„æ›´æ”¹..."
          git stash pop || true
          git add fund_data/*.csv || true 
        fi
        
    - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹ (Commit and Push changes)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– å‡€å€¼æ•°æ®æ›´æ–°å®Œæˆ"
        # æœ€ç»ˆä¿®å¤ï¼šç§»é™¤ä¸å­˜åœ¨çš„ 'fund_fee_result.csv' ä»¥é¿å… pathspec é”™è¯¯ã€‚
        file_pattern: 'Cç±».txt fund_data/*.csv'
        commit_options: '--allow-empty'
